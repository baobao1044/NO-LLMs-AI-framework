# NO-LLMs-AI-framework

MVP for a verification-first learning environment.

Current phase scope:
- no ML
- no neural networks
- no prompt optimization
- only a minimal agent loop

## Environment

- Node pinned via `.nvmrc` (`24.11.1`)
- TypeScript pinned in `templates/ts_project/package.json` and `templates/ts_project/package-lock.json`
- Python: use current `python3`

Quick setup:

```bash
nvm use
python3 -V
node -v
```

## Core Loop

```
task -> execute -> verify -> log -> done
```

Agent behavior in this phase:
- execute deterministic code attempts
- try rule-based patchers immediately after a failed verify
- verify with strict function test cases
- log every attempt as JSONL
- stop when pass, otherwise continue until attempts exhausted

Event log schema now includes:
- `run_id`, `attempt_index`
- `language` (`py` / `ts`)
- `failure_type`, `error_signature`
- `verifier_name`, `verifier_version`
- `artifact_hash`, `task_hash`
- `task_payload` for exact replay
- `payload_is_lossy` to mark non-JSON payload fallback
- `patcher_attempted`, `patcher_id`, `patch_applied`, `patch_summary`
- `parent_artifact_hash`, `changed_lines_count`, `changed_line_numbers`, `delta_summary`
- `verifier_stage_failed` (`syntax` / `unit_test` / `timeout`)
  - TypeScript pipeline uses `tsc` / `build` / `unit_test` / `timeout`
- proposer fields (`schema_version=2.5.0`):
  - `proposer_used`, `proposer_id`, `proposal_hash`
  - `proposer_latency_ms`, `proposer_budget_spent`, `proposer_input_hash`

## Project Layout

```text
core/
  agent.py
  proposers/
  verifier.py
  patchers/
  patchers_ts/
  verifiers/
  error_classifier_ts.py
  logger.py
  task.py
templates/
  ts_project/
examples/
  add_task_demo.py
tests/
  test_agent_loop.py
  test_patchers.py
  test_tools.py
  test_verifier_pipeline.py
  test_curriculum_regress.py
tools/
  replay.py
  stats.py
  curriculum.py
  regress.py
  patch_mining.py
  build_patch_backlog.py
  pick_backlog_items.py
  collect_quality_metrics.py
  patcher_quality_gate.py
  build_progress_report.py
  build_daily_summary.py
  create_run_pack.py
  merge_logs.py
  dedup_report.py
  run_daily.py
  ab_compare.py
  build_changelog.py
  ci_gate.py
  build_uncovered_list.py
  quarantine_flakes.py
  scaffold_patcher.py
  generate_tasks.py
configs/
  golden_set.json
  ts_golden_set.json
  regression_baseline.json (generated by tool)
  ts_regression_baseline.json (generated by tool)
  backlog_policy.json
  backlog_selected.json
  patcher_quality_baseline.json
  governance_policy.json
  proposer_policy.json
  uncovered_signatures.json
  daily_config.json
  tasks_generated.json (optional, generated by tool)
  ts_generated_tasks.json (optional, generated by tool)
  patch_backlog_schema.json
runs/
  YYYYMMDD/
    agent_runs.jsonl
    metadata.json
reports/
  YYYYMMDD/
    daily_summary.json
    replay_metrics.json
```

## Quick Start

Run the demo:

```bash
python3 examples/add_task_demo.py
```

Run tests:

```bash
python3 -m unittest discover -s tests -p "test_*.py"
```

Replay determinism check:

```bash
python3 tools/replay.py logs/agent_runs.jsonl
python3 tools/replay.py logs/agent_runs.jsonl --json-out reports/replay_metrics.json
```

Replay now includes env fingerprint mismatch counter:
- `env_fingerprint_mismatch_count`

Minimal analytics:

```bash
python3 tools/stats.py logs/agent_runs.jsonl
```

Patch mining report:

```bash
python3 tools/patch_mining.py --log logs/agent_runs.jsonl --top-k 50 --min-count 3
```

Coverage-driven patch backlog:

```bash
python3 tools/build_patch_backlog.py --log logs/agent_runs.jsonl --language all --top-k 50 --min-count 3 --out configs/patch_backlog_all.json
```

Pick top backlog items by policy:

```bash
python3 tools/pick_backlog_items.py --backlog configs/patch_backlog_all.json --policy configs/backlog_policy.json --out configs/backlog_selected.json
```

Scaffold patcher skeleton:

```bash
python3 tools/scaffold_patcher.py --language ts --category type_fix --signature "TS2322:" --name ts_fix_ts2322
python3 tools/scaffold_patcher.py --language py --category syntax_fix --name py_fix_syntax
```

Task generation (deterministic, JSON-only):

```bash
python3 tools/generate_tasks.py --out configs/tasks_generated.json --seed 123 --count 20
python3 tools/generate_tasks.py --out configs/tasks_generated.json --seed 123 --count 20 --append-golden configs/golden_set.json
python3 tools/generate_tasks.py --out configs/ts_generated_tasks.json --seed 123 --count 20 --templates ts_union_narrowing,ts_optional_chaining,ts_generic_identity,ts_record_shape,ts_null_undefined_strict --tag generated
```

Run packs and merge/dedup:

```bash
python3 tools/create_run_pack.py --date 20260209 --seed 123
python3 tools/merge_logs.py "runs/*/agent_runs.jsonl" --out logs/merged.jsonl
python3 tools/dedup_report.py logs/merged.jsonl --json-out reports/dedup_report.json
```

Flake quarantine:

```bash
python3 tools/quarantine_flakes.py --replay-metrics reports/replay_metrics.json --out configs/flaky_quarantine.json
```

Build curriculum (offline):

```bash
python3 tools/curriculum.py logs/agent_runs.jsonl --output curriculum.json --mode easy_to_hard
```

Regression gate:

```bash
python3 tools/regress.py --golden-set configs/golden_set.json --baseline configs/regression_baseline.json --update-baseline
python3 tools/regress.py --golden-set configs/golden_set.json --baseline configs/regression_baseline.json
python3 tools/regress.py --golden-set configs/ts_golden_set.json --baseline configs/ts_regression_baseline.json --update-baseline
python3 tools/regress.py --golden-set configs/ts_golden_set.json --baseline configs/ts_regression_baseline.json
```

Baseline is only updated when `--update-baseline` is explicitly passed.

Build uncovered signature list for proposer gating:

```bash
python3 tools/build_uncovered_list.py --backlog configs/patch_backlog_all.json --out configs/uncovered_signatures.json
```

Daily A/B run (baseline vs proposer-enabled):

```bash
python3 tools/run_daily.py --config configs/daily_config.json --date 20260209 --ab
python3 tools/ab_compare.py --a reports/20260209_A/daily_summary.json --b reports/20260209_B/daily_summary.json --out-json reports/20260209/ab_compare.json --out-md reports/20260209/ab_compare.md
```

Release governance:

```bash
python3 tools/build_changelog.py
python3 tools/ci_gate.py
```

## Make Targets

```bash
make test
make replay
make regress
make mine
make gen-tasks
make gen-ts-tasks
make backlog
make select-backlog
make quality
make refresh
make merge-logs
make dedup-report
make daily
make changelog
make ci
```
VERSION
CHANGELOG.md
